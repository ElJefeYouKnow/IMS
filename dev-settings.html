<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dev Settings</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body class="page">
  <div class="page-shell">
    <header class="page-header">
      <div class="header-title">
        <div class="pill pill-strong">Dev Controls</div>
        <h1>Developer Settings</h1>
        <p class="muted">For dev tenant only. Destructive tools live here.</p>
      </div>
      <div class="header-actions">
        <button id="logoutBtn" class="btn ghost">Logout</button>
      </div>
    </header>

    <main class="content-grid">
      <section class="card">
        <div class="card-header">
          <div>
            <p class="muted">Signed in as</p>
            <h2 id="devUserEmail">—</h2>
            <p class="muted">Tenant: <span id="devTenant">—</span></p>
          </div>
          <div class="pill pill-info">Dev role</div>
        </div>
        <div class="card-body">
          <p>Use these controls only in the dev tenant. Production data must never be cleared here.</p>
          <div class="form-row">
            <label>Dev token
              <input id="devToken" type="password" placeholder="optional override token" />
            </label>
          </div>
          <div class="action-row">
            <div>
              <h3>Hard Reset (truncate)</h3>
              <p class="muted">Clears all data, reseeds admin + dev users. Requires reset token.</p>
            </div>
            <button id="devResetBtn" class="btn danger">Run dev reset</button>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="card-header">
          <div>
            <h2>Delete user (dev only)</h2>
            <p class="muted">Removes a specific user and their audit/inventory references.</p>
          </div>
        </div>
        <div class="card-body">
          <div class="form-row">
            <label>Tenant code
              <input id="delUserTenant" placeholder="tenant code (e.g. dev)" />
            </label>
            <label>Email
              <input id="delUserEmail" type="email" placeholder="user@example.com" />
            </label>
          </div>
          <button id="deleteUserBtn" class="btn danger">Delete user</button>
        </div>
      </section>

      <section class="card">
        <div class="card-header">
          <div>
            <h2>Delete tenant (dev only)</h2>
            <p class="muted">Deletes tenant and all data. Protected: default/dev tenants.</p>
          </div>
        </div>
        <div class="card-body">
          <div class="form-row">
            <label>Tenant code
              <input id="delTenantCode" placeholder="tenant code" />
            </label>
          </div>
          <button id="deleteTenantBtn" class="btn danger">Delete tenant</button>
        </div>
      </section>

      <section class="card">
        <div class="card-header">
          <div>
            <h2>Tenants</h2>
            <p class="muted">List all tenants (dev view only).</p>
          </div>
          <button id="loadTenantsBtn" class="btn ghost">Refresh</button>
        </div>
        <div class="card-body">
          <table class="data-table" id="tenantsTable">
            <thead><tr><th>Code</th><th>Name</th><th>ID</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section class="card">
        <div class="card-header">
          <div>
            <h2>Users by tenant</h2>
            <p class="muted">View users for a specific tenant code.</p>
          </div>
        </div>
        <div class="card-body">
          <div class="form-row">
            <label>Tenant code
              <input id="listUsersTenant" placeholder="tenant code" />
            </label>
            <button id="loadUsersBtn" class="btn ghost">Load users</button>
          </div>
          <table class="data-table" id="usersTable">
            <thead><tr><th>Email</th><th>Name</th><th>Role</th><th>Tenant</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <script src="js/utils.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const user = utils.getSession();
      if (!user) {
        window.location.href = 'login.html';
        return;
      }
      const tenantId = (user.tenantId || user.tenantid || '').toLowerCase();
      const role = (user.role || '').toLowerCase();
      const isDevTenant = tenantId === 'dev';
      const isDevRole = role === 'dev';
      const hasDevAccess = isDevTenant || isDevRole;
      if (!hasDevAccess) {
        alert('Access denied: dev tenant only');
        window.location.href = 'dashboard.html';
        return;
      }
      document.getElementById('devUserEmail').textContent = user.email || 'Unknown';
      document.getElementById('devTenant').textContent = user.tenantId || 'dev';

      utils.setupLogout?.();

      const tokenInput = document.getElementById('devToken');
      const getToken = () => (tokenInput?.value || '').trim();

      document.getElementById('devResetBtn').addEventListener('click', async () => {
        const token = prompt('Enter dev reset token (this will wipe all data).');
        if (!token) return;
        if (!confirm('This will TRUNCATE all data for this environment. Continue?')) return;
        try {
          const res = await fetch('/api/dev/reset', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-dev-reset': token,
              'x-dev-token': getToken()
            }
          });
          if (res.ok) {
            alert('Reset complete. You will be logged out.');
            localStorage.removeItem('sessionUser');
            await fetch('/api/auth/logout',{method:'POST'}).catch(()=>{});
            window.location.href='login.html';
          } else {
            const data = await res.json().catch(() => ({ error: 'Reset failed' }));
            alert(data.error || 'Reset failed');
          }
        } catch (err) {
          alert('Reset failed: ' + err.message);
        }
      });

      const deleteUserBtn = document.getElementById('deleteUserBtn');
      const delUserTenant = document.getElementById('delUserTenant');
      const delUserEmail = document.getElementById('delUserEmail');
      delUserTenant.value = tenantId || 'dev';
      deleteUserBtn.addEventListener('click', async () => {
        const tcode = delUserTenant.value.trim();
        const email = delUserEmail.value.trim();
        if (!tcode || !email) return alert('Tenant code and email required');
        if (!confirm(`Delete user ${email} in tenant ${tcode}? This cannot be undone.`)) return;
        try {
          const res = await fetch('/api/dev/delete-user', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'x-dev-token': getToken() },
            body: JSON.stringify({ tenantCode: tcode, email })
          });
          const data = await res.json().catch(()=>({}));
          if (!res.ok) return alert(data.error || 'Delete failed');
          alert('User deleted.');
        } catch (err) {
          alert('Delete failed: ' + err.message);
        }
      });

      const deleteTenantBtn = document.getElementById('deleteTenantBtn');
      const delTenantCode = document.getElementById('delTenantCode');
      deleteTenantBtn.addEventListener('click', async () => {
        const tcode = delTenantCode.value.trim();
        if (!tcode) return alert('Tenant code required');
        if (!confirm(`Delete tenant ${tcode} and ALL its data? This cannot be undone.`)) return;
        try {
          const res = await fetch('/api/dev/delete-tenant', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'x-dev-token': getToken() },
            body: JSON.stringify({ tenantCode: tcode })
          });
          const data = await res.json().catch(()=>({}));
          if (!res.ok) return alert(data.error || 'Delete failed');
          alert('Tenant deleted.');
        } catch (err) {
          alert('Delete failed: ' + err.message);
        }
      });
      const tenantsTableBody = document.querySelector('#tenantsTable tbody');
      document.getElementById('loadTenantsBtn').addEventListener('click', async ()=>{
        tenantsTableBody.innerHTML = '<tr><td colspan="3">Loading...</td></tr>';
        try{
          const res = await fetch('/api/dev/tenants', { headers: { 'x-dev-token': getToken() }});
          const data = await res.json().catch(()=>[]);
          if(!res.ok) return alert(data.error || 'Load failed');
          tenantsTableBody.innerHTML = '';
          data.forEach(t=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${t.code}</td><td>${t.name}</td><td>${t.id}</td>`;
            tenantsTableBody.appendChild(tr);
          });
          if(!data.length) tenantsTableBody.innerHTML = '<tr><td colspan="3">None</td></tr>';
        }catch(err){
          tenantsTableBody.innerHTML = '<tr><td colspan="3">Error</td></tr>';
        }
      });

      const usersTableBody = document.querySelector('#usersTable tbody');
      const listUsersTenant = document.getElementById('listUsersTenant');
      document.getElementById('loadUsersBtn').addEventListener('click', async ()=>{
        const tcode = listUsersTenant.value.trim();
        if(!tcode) return alert('Tenant code required');
        usersTableBody.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';
        try{
          const res = await fetch('/api/dev/users?tenantCode='+encodeURIComponent(tcode), { headers: { 'x-dev-token': getToken() }});
          const data = await res.json().catch(()=>[]);
          if(!res.ok) return alert(data.error || 'Load failed');
          usersTableBody.innerHTML = '';
          data.forEach(u=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${u.email}</td><td>${u.name||''}</td><td>${u.role}</td><td>${u.tenantid||u.tenantId}</td>`;
            usersTableBody.appendChild(tr);
          });
          if(!data.length) usersTableBody.innerHTML = '<tr><td colspan="4">None</td></tr>';
        }catch(err){
          usersTableBody.innerHTML = '<tr><td colspan="4">Error</td></tr>';
        }
      });
    });
  </script>
</body>
</html>
